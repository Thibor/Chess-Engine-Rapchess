var version="18-02-01",piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,colorBlack=8,colorWhite=16,colorEmpty=32,moveflagPassing=2<<16,moveflagCastleKing=4<<16,moveflagCastleQueen=8<<16,moveflagPromotion=240<<16,moveflagPromoteQueen=16<<16,moveflagPromoteRook=32<<16,moveflagPromoteBishop=64<<16,moveflagPromoteKnight=8388608,maskCastle=moveflagCastleKing|moveflagCastleQueen,maskColor=colorBlack|colorWhite,g_baseEval=0,g_captured=0,g_castleRights=15,g_depth=0,g_passing=0,g_move50=0,g_moveNumber=0,g_pv="",g_totalNodes=0,g_startTime=0,g_inCheck=!1,g_depthout=0,g_timeout=0,g_nodeout=0,g_stop=!1,g_scoreFm="",g_lastCastle=0,undoStack=[],g_board=new Array(256),boardCheck=new Array(256),boardCastle=new Array(256),g_pieceIndex=new Array(256),g_pieceList=new Array(256),g_pieceCount=new Array(16),whiteTurn=!0,colorEnemy=colorBlack,arrMaterial=[0,100,300,300,500,800,65535];function StrToSquare(e){return{a:0,b:1,c:2,d:3,e:4,f:5,g:6,h:7}[e.charAt(0)]+4|12-parseInt(e.charAt(1))<<4}function FormatSquare(e){return["a","b","c","d","e","f","g","h"][(15&e)-4]+(12-(e>>4))}function FormatMove(e){var o=FormatSquare(255&e)+FormatSquare(e>>8&255);return e&moveflagPromotion&&(o+=e&moveflagPromoteQueen?"q":e&moveflagPromoteRook?"r":e&moveflagPromoteBishop?"b":"n"),o}function GetMoveFromString(e){for(var o=GenerateAllMoves(whiteTurn),t=0;t<o.length;t++)if(FormatMove(o[t])==e)return o[t]}function Initialize(){for(var e=0;e<256;e++){var o=15&e,t=e>>4;boardCheck[e]=0,boardCastle[e]=15,g_board[e]=o>3&&t>3&&o<12&&t<12?colorEmpty:0}var a=[[68,7],[72,3],[75,11],[180,13],[184,12],[187,14]];for(e=0;e<a.length;e++)boardCastle[a[e][0]]=a[e][1];var r=[[71,colorBlack|moveflagCastleQueen],[72,colorBlack|maskCastle],[73,colorBlack|moveflagCastleKing],[183,colorWhite|moveflagCastleQueen],[184,colorWhite|maskCastle],[185,colorWhite|moveflagCastleKing]];for(e=0;e<a.length;e++)boardCheck[r[e][0]]=r[e][1]}function InitializeFromFen(e){for(var o=0;o<256;o++)g_board[o]&&(g_board[o]=colorEmpty);e||(e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");for(var t=e.split(" "),a=0,r=0,g=t[0],i=0;i<g.length;i++){var n=g.charAt(i);if("/"==n)a++,r=0;else if(n>="0"&&n<="9")for(var s=0;s<parseInt(n);s++)r++;else{var _=n.toLowerCase(),c=_==n?colorBlack:colorWhite,l=16*(a+4)+r+4;switch(_){case"p":c|=piecePawn;break;case"b":c|=pieceBishop;break;case"n":c|=pieceKnight;break;case"r":c|=pieceRook;break;case"q":c|=pieceQueen;break;case"k":c|=pieceKing}g_board[l]=c,r++}}whiteTurn="w"==t[1].charAt(0),g_castleRights=0,-1!=t[2].indexOf("K")&&(g_castleRights|=1),-1!=t[2].indexOf("Q")&&(g_castleRights|=2),-1!=t[2].indexOf("k")&&(g_castleRights|=4),-1!=t[2].indexOf("q")&&(g_castleRights|=8),g_passing=0,-1==t[3].indexOf("-")&&(g_passing=StrToSquare(t[3])),g_move50=parseInt(t[4]),(g_moveNumber=parseInt(t[5]))&&g_moveNumber--,g_moveNumber*=2,whiteTurn||g_moveNumber++,undoStack=[],InitializePieceList()}function InitializePieceList(){g_baseEval=0;for(var e=0;e<16;e++){g_pieceCount[e]=0;for(var o=0;o<16;o++)g_pieceList[e<<4|o]=0}for(e=0;e<256;e++){g_pieceIndex[e]=0;var t=15&g_board[e];t&&(g_pieceList[t<<4|g_pieceCount[t]]=e,g_pieceIndex[e]=g_pieceCount[t],g_pieceCount[t]++,t&colorBlack?g_baseEval-=arrMaterial[7&t]:g_baseEval+=arrMaterial[7&t])}whiteTurn||(g_baseEval=-g_baseEval)}function GenerateMove(e,o,t,a,r){a&&(e[e.length]=o|t<<8|r),((7&g_board[t])==pieceKing||(boardCheck[t]&g_lastCastle)==g_lastCastle&&g_lastCastle&maskCastle)&&(g_inCheck=!0)}function GenerateAllMoves(e){g_inCheck=!1,colorEnemy=e?colorBlack:colorWhite,maskEE=colorEnemy|colorEmpty;for(var o,t,a=[],r=e?0:8,g=(1|r)<<4,i=g_pieceList[g++];i;)if(a.length,g_board[o=i+(t=e?-16:16)]&colorEmpty&&(GeneratePwnMoves(a,i,o,!0),!g_board[i-t-t]&&g_board[o+t]&colorEmpty&&GeneratePwnMoves(a,i,o+t,!0)),g_board[o-1]&colorEnemy?GeneratePwnMoves(a,i,o-1,!0):o-1==g_passing?GeneratePwnMoves(a,i,g_passing,!0,moveflagPassing):g_board[o-1]&colorEmpty&&GeneratePwnMoves(a,i,o-1,!1),g_board[o+1]&colorEnemy?GeneratePwnMoves(a,i,o+1,!0):o+1==g_passing?GeneratePwnMoves(a,i,g_passing,!0,moveflagPassing):g_board[o+1]&colorEmpty&&GeneratePwnMoves(a,i,o+1,!1),i=g_pieceList[g++],g_inCheck)return[];for(g=(2|r)<<4,i=g_pieceList[g++];i;)if(a.length,GenerateShrMoves(a,i,[14,-14,18,-18,31,-31,33,-33]),i=g_pieceList[g++],g_inCheck)return[];for(g=(3|r)<<4,i=g_pieceList[g++];i;)if(a.length,GenerateStdMoves(a,i,[15,-15,17,-17]),i=g_pieceList[g++],g_inCheck)return[];for(g=(4|r)<<4,i=g_pieceList[g++];i;)if(a.length,GenerateStdMoves(a,i,[1,-1,16,-16]),i=g_pieceList[g++],g_inCheck)return[];for(g=(5|r)<<4,i=g_pieceList[g++];i;)if(a.length,GenerateStdMoves(a,i,[1,-1,15,-15,16,-16,17,-17]),i=g_pieceList[g++],g_inCheck)return[];for(g=(6|r)<<4,i=g_pieceList[g++];i;){a.length,GenerateShrMoves(a,i,[1,-1,15,-15,16,-16,17,-17]);var n=e?g_castleRights:g_castleRights>>2;if(1&n&&g_board[i+1]==colorEmpty&&g_board[i+2]==colorEmpty&&GenerateMove(a,i,i+2,!0,moveflagCastleKing),2&n&&g_board[i-1]==colorEmpty&&g_board[i-2]==colorEmpty&&g_board[i-3]==colorEmpty&&GenerateMove(a,i,i-2,!0,moveflagCastleQueen),i=g_pieceList[g++],g_inCheck)return[]}return a}function GeneratePwnMoves(e,o,t,a,r){var g=t>>4;4!=g&&11!=g||!a?GenerateMove(e,o,t,a,r):(GenerateMove(e,o,t,a,moveflagPromoteQueen),GenerateMove(e,o,t,a,moveflagPromoteRook),GenerateMove(e,o,t,a,moveflagPromoteBishop),GenerateMove(e,o,t,a,moveflagPromoteKnight))}function GenerateShrMoves(e,o,t){for(var a=0;a<t.length;a++){var r=o+t[a];g_board[r]&maskEE&&GenerateMove(e,o,r,!0)}}function GenerateStdMoves(e,o,t){for(var a=0;a<t.length;a++){for(var r=o+t[a];g_board[r]&colorEmpty;)GenerateMove(e,o,r,!0),r+=t[a];g_board[r]&colorEnemy&&GenerateMove(e,o,r,!0)}}function MakeMove(e){var o=255&e,t=e>>8&255,a=16711680&e,r=g_board[o],g=15&r,i=t;if(g_captured=g_board[t],g_lastCastle=e&maskCastle|r&maskColor,a&moveflagCastleKing){var n=g_board[t+1];g_board[t-1]=n,g_board[t+1]=colorEmpty;var s=g_pieceIndex[t+1];g_pieceIndex[t-1]=s,g_pieceList[(15&n)<<4|s]=t-1}else if(a&moveflagCastleQueen){n=g_board[t-2];g_board[t+1]=n,g_board[t-2]=colorEmpty;s=g_pieceIndex[t-2];g_pieceIndex[t+1]=s,g_pieceList[(15&n)<<4|s]=t+1}else a&moveflagPassing&&(g_captured=g_board[i=whiteTurn?t+16:t-16],g_board[i]=colorEmpty);undoStack.push(new cUndo),g_passing=0;var _=15&g_captured;if(_){g_pieceCount[_]--;var c=g_pieceList[_<<4|g_pieceCount[_]];g_pieceIndex[c]=g_pieceIndex[i],g_pieceList[_<<4|g_pieceIndex[c]]=c,g_pieceList[_<<4|g_pieceCount[_]]=0,g_baseEval+=arrMaterial[7&g_captured],g_move50=0}else(7&g)==piecePawn?(t==o+32&&(g_passing=o+16),t==o-32&&(g_passing=o-16),g_move50=0):g_move50++;if(g_pieceIndex[t]=g_pieceIndex[o],g_pieceList[g<<4|g_pieceIndex[t]]=t,a&moveflagPromotion){var l=-8&r;l|=a&moveflagPromoteKnight?pieceKnight:a&moveflagPromoteQueen?pieceQueen:a&moveflagPromoteBishop?pieceBishop:pieceRook,g_board[t]=l;var p=15&l;g_pieceCount[g]--;var v=g_pieceList[g<<4|g_pieceCount[g]];g_pieceIndex[v]=g_pieceIndex[t],g_pieceList[g<<4|g_pieceIndex[v]]=v,g_pieceList[g<<4|g_pieceCount[g]]=0,g_pieceIndex[t]=g_pieceCount[p],g_pieceList[p<<4|g_pieceIndex[t]]=t,g_pieceCount[p]++,g_baseEval-=arrMaterial[7&g],g_baseEval+=arrMaterial[7&l]}else g_board[t]=g_board[o];g_board[o]=colorEmpty,g_castleRights&=boardCastle[o]&boardCastle[t],g_baseEval=-g_baseEval,whiteTurn=!whiteTurn,g_moveNumber++}function UnmakeMove(e){var o=255&e,t=e>>8&255,a=16711680&e,r=g_board[t],g=t,i=undoStack[undoStack.length-1];undoStack.pop(),g_passing=i.passing,g_castleRights=i.castle,g_move50=i.move50,g_baseEval=i.value,g_lastCastle=i.lastCastle;var n=i.captured;if(a&moveflagCastleKing){var s=g_board[t-1];g_board[t+1]=s,g_board[t-1]=colorEmpty;var _=g_pieceIndex[t-1];g_pieceIndex[t+1]=_,g_pieceList[(15&s)<<4|_]=t+1}else if(a&moveflagCastleQueen){s=g_board[t+1];g_board[t-2]=s,g_board[t+1]=colorEmpty;_=g_pieceIndex[t+1];g_pieceIndex[t-2]=_,g_pieceList[(15&s)<<4|_]=t-2}if(a&moveflagPromotion){r=-8&g_board[t]|piecePawn,g_board[o]=r;var c=15&g_board[o],l=15&g_board[t];g_pieceCount[l]--;var p=g_pieceList[l<<4|g_pieceCount[l]];g_pieceIndex[p]=g_pieceIndex[t],g_pieceList[l<<4|g_pieceIndex[p]]=p,g_pieceList[l<<4|g_pieceCount[l]]=0,g_pieceIndex[t]=g_pieceCount[c],g_pieceList[c<<4|g_pieceIndex[t]]=t,g_pieceCount[c]++}else g_board[o]=g_board[t];a&moveflagPassing&&(g=whiteTurn?t-16:t+16,g_board[t]=colorEmpty),g_board[g]=n,g_pieceIndex[o]=g_pieceIndex[t],g_pieceList[(15&r)<<4|g_pieceIndex[o]]=o;var v=15&n;v&&(g_pieceIndex[g]=g_pieceCount[v],g_pieceList[v<<4|g_pieceCount[v]]=g,g_pieceCount[v]++),whiteTurn=!whiteTurn,g_moveNumber--}var bsIn=-1,bsFm="",bsPv="";function GetScore(e,o,t,a,r,g){for(var i=e.length,n=i,s=n,_=0,c="",l="";n--;){8191&++g_totalNodes||(g_stop=a>1&&(g_timeout&&Date.now()-g_startTime>g_timeout||g_nodeout&&g_totalNodes>g_nodeout));var p=e[n],v=7&g_board[p>>8&255];MakeMove(p),g_depth=0,g_pv="";var m=-g_baseEval+i-o;if(g_move50>99)m=0;else if(t<a||v){var d=GenerateAllMoves(whiteTurn);g_inCheck?(s--,m=-65535):m=-GetScore(d,i,t+1,a,-g,-r)}if(UnmakeMove(p),g_stop)return-65535;if(r<m&&(r=m,l=(c=FormatMove(p))+" "+g_pv,_=g_depth+1,1==t)){g_scoreFm=m>61440?"mate "+(65535-m>>1):m<-61440?"mate "+(-65534-m>>1):"cp "+(m>>2),bsIn=n,bsFm=c,bsPv=l;var u=Date.now()-g_startTime,b=Math.floor(g_totalNodes/u*1e3);postMessage("info currmove "+bsFm+" currmovenumber "+n+" nodes "+g_totalNodes+" time "+u+" nps "+b+" depth "+g_depthout+" seldepth "+_+" score "+g_scoreFm+" pv "+bsPv)}if(r>=g)break}return s||(GenerateAllMoves(!whiteTurn),r=g_inCheck?-65535+t:0),g_depth=_,g_pv=l,r}function Search(e,o,t){var a=GenerateAllMoves(whiteTurn),r=a.length,g=a.length-1;g_stop=!1,g_totalNodes=0,g_depthout=e||1,g_timeout=o,g_nodeout=t;do{bsIn=g;var i=GetScore(a,r,1,g_depthout,-65535,65535);if(bsIn!=g){var n=a[g];a[g]=a[bsIn],a[bsIn]=n}if(g_depth<g_depthout++||i<-61440||i>61440)break}while((!e||g_depthout<e)&&!g_stop&&g);o=Date.now()-g_startTime;var s=Math.floor(g_totalNodes/o*1e3),_=bsPv.split(" "),c=_.length>1?" ponder "+_[1]:"";return postMessage("info nodes "+g_totalNodes+" time "+o+" nps "+s),postMessage("bestmove "+bsFm+c),!0}var cUndo=function(){this.captured=g_captured,this.passing=g_passing,this.castle=g_castleRights,this.move50=g_move50,this.value=g_baseEval,this.lastCastle=g_lastCastle};function GetNumber(e,o,t){var a=o.exec(e);return a?0|a[1]:t}Initialize(),onmessage=function(e){/^(.*?)\n?$/.exec(e.data);var o=RegExp.$1;if("uci"==o)postMessage("id name Rapshort "+version),postMessage("id author Thibor Raven"),postMessage("uciok");else if("isready"==o)postMessage("readyok");else if(/^position (?:(startpos)|fen (.*?))\s*(?:moves\s*(.*))?$/.exec(o)){if(InitializeFromFen("startpos"==RegExp.$1?"":RegExp.$2),RegExp.$3)for(var t=RegExp.$3.split(" "),a=0;a<t.length;a++)MakeMove(GetMoveFromString(t[a]))}else if(/^go /.exec(o)){g_startTime=Date.now();var r=GetNumber(o,/movetime (\d+)/,0),g=GetNumber(o,/depth (\d+)/,0),i=GetNumber(o,/nodes (\d+)/,0);if(!r&&!g&&!i){var n=GetNumber(o,whiteTurn?/wtime (\d+)/:/btime (\d+)/,0),s=GetNumber(o,whiteTurn?/winc (\d+)/:/binc (\d+)/,0),_=GetNumber(o,/movestogo (\d+)/,32);r=Math.floor(n/_)+s-255}Search(g,r,i)}};