var version="18-02-01",piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,colorBlack=8,colorWhite=16,colorEmpty=32,moveflagPassing=2<<16,moveflagCastleKing=4<<16,moveflagCastleQueen=8<<16,moveflagPromotion=240<<16,moveflagPromoteQueen=16<<16,moveflagPromoteRook=32<<16,moveflagPromoteBishop=64<<16,moveflagPromoteKnight=8388608,maskCastle=moveflagCastleKing|moveflagCastleQueen,maskColor=colorBlack|colorWhite,adjMobility=0,g_captured=0,g_castleRights=15,g_depth=0,g_passing=0,g_move50=0,g_moveNumber=0,g_pv="",g_totalNodes=0,g_startTime=0,g_inCheck=!1,g_depthout=0,g_timeout=0,g_nodeout=0,g_stop=!1,g_scoreFm="",g_lastCastle=0,undoStack=[],arrField=[],g_board=new Array(256),boardCheck=new Array(256),boardCastle=new Array(256),whiteTurn=1,usColor=0,enColor=0,eeColor=0,arrMaterial=[0,100,300,300,500,800,65535];function StrToSquare(e){return{a:0,b:1,c:2,d:3,e:4,f:5,g:6,h:7}[e.charAt(0)]+4|12-parseInt(e.charAt(1))<<4}function FormatSquare(e){return["a","b","c","d","e","f","g","h"][(15&e)-4]+(12-(e>>4))}function FormatMove(e){var o=FormatSquare(255&e)+FormatSquare(e>>8&255);return e&moveflagPromotion&&(o+=e&moveflagPromoteQueen?"q":e&moveflagPromoteRook?"r":e&moveflagPromoteBishop?"b":"n"),o}function GetMoveFromString(e){for(var o=GenerateAllMoves(whiteTurn),a=0;a<o.length;a++)if(FormatMove(o[a])==e)return o[a]}function Initialize(){arrField=[];for(var e=0;e<256;e++)boardCheck[e]=0,boardCastle[e]=15,g_board[e]=0;for(var o=0;o<8;o++)for(var a=0;a<8;a++)arrField.push(16*(o+4)+a+4);for(e=0;e<6;e++)boardCastle[[68,72,75,180,184,187][e]]=[7,3,11,13,12,14][e],boardCheck[[71,72,73,183,184,185][e]]=[colorBlack|moveflagCastleQueen,colorBlack|maskCastle,colorBlack|moveflagCastleKing,colorWhite|moveflagCastleQueen,colorWhite|maskCastle,colorWhite|moveflagCastleKing][e]}function InitializeFromFen(e){for(var o=0;o<64;o++)g_board[arrField[o]]=colorEmpty;e||(e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");for(var a=e.split(" "),t=0,r=0,s=a[0],g=0;g<s.length;g++){var n=s.charAt(g);if("/"==n)t++,r=0;else if(n>="0"&&n<="9")for(var l=0;l<parseInt(n);l++)r++;else{var i=n.toLowerCase(),c=i!=n?colorWhite:colorBlack,m=16*(t+4)+r+4;switch(i){case"p":c|=piecePawn;break;case"b":c|=pieceBishop;break;case"n":c|=pieceKnight;break;case"r":c|=pieceRook;break;case"q":c|=pieceQueen;break;case"k":c|=pieceKing}g_board[m]=c,r++}}whiteTurn="w"==a[1].charAt(0)|0,g_castleRights=0,-1!=a[2].indexOf("K")&&(g_castleRights|=1),-1!=a[2].indexOf("Q")&&(g_castleRights|=2),-1!=a[2].indexOf("k")&&(g_castleRights|=4),-1!=a[2].indexOf("q")&&(g_castleRights|=8),g_passing=0,-1==a[3].indexOf("-")&&(g_passing=StrToSquare(a[3])),g_move50=parseInt(a[4]),(g_moveNumber=parseInt(a[5]))&&g_moveNumber--,g_moveNumber*=2,whiteTurn||g_moveNumber++,undoStack=[]}var countNA=0;function GenerateMove(e,o,a,t){adjMobility++;var r=7&g_board[a];if(r==pieceKing||g_lastCastle&maskCastle&&(boardCheck[a]&g_lastCastle)==g_lastCastle)g_inCheck=!0;else{var s=o|a<<8|t;r||t==moveflagPassing?e[e.length]=s:(e[e.length]=e[countNA],e[countNA++]=s)}}function GenerateAllMoves(e){g_inCheck=!1,countNA=0,adjMobility=0,usColor=e?colorWhite:colorBlack,eeColor=(enColor=e?colorBlack:colorWhite)|colorEmpty;for(var o=[],a=0;a<64;a++){var t=arrField[a],r=g_board[t];if(r&usColor)switch(adjMobility+=arrMaterial[r&=7],r){case 1:var s=e?-16:16,g=t+s;g_board[g]&colorEmpty&&(GeneratePwnMoves(o,t,g,!0),!g_board[t-s-s]&&g_board[g+s]&colorEmpty&&GeneratePwnMoves(o,t,g+s,!0)),g_board[g-1]&enColor?GeneratePwnMoves(o,t,g-1,!0):g-1==g_passing?GeneratePwnMoves(o,t,g_passing,!0,moveflagPassing):g_board[g-1]&colorEmpty&&GeneratePwnMoves(o,t,g-1,!1),g_board[g+1]&enColor?GeneratePwnMoves(o,t,g+1,!0):g+1==g_passing?GeneratePwnMoves(o,t,g_passing,!0,moveflagPassing):g_board[g+1]&colorEmpty&&GeneratePwnMoves(o,t,g+1,!1);break;case 2:GenerateShrMoves(o,t,[14,-14,18,-18,31,-31,33,-33]);break;case 3:GenerateStdMoves(o,t,[15,-15,17,-17]);break;case 4:GenerateStdMoves(o,t,[1,-1,16,-16]);break;case 5:GenerateStdMoves(o,t,[1,-1,15,-15,16,-16,17,-17]);break;case 6:GenerateShrMoves(o,t,[1,-1,15,-15,16,-16,17,-17]);var n=e?g_castleRights:g_castleRights>>2;1&n&&g_board[t+1]&colorEmpty&&g_board[t+2]&colorEmpty&&GenerateMove(o,t,t+2,moveflagCastleKing),2&n&&g_board[t-1]&colorEmpty&&g_board[t-2]&colorEmpty&&g_board[t-3]&colorEmpty&&GenerateMove(o,t,t-2,moveflagCastleQueen)}}return o}function GeneratePwnMoves(e,o,a,t,r){if((boardCheck[a]&g_lastCastle)==g_lastCastle&&g_lastCastle&maskCastle)g_inCheck=!0;else if(t){var s=a>>4;4==s||11==s?(GenerateMove(e,o,a,moveflagPromoteQueen),GenerateMove(e,o,a,moveflagPromoteRook),GenerateMove(e,o,a,moveflagPromoteBishop),GenerateMove(e,o,a,moveflagPromoteKnight)):GenerateMove(e,o,a,r)}}function GenerateShrMoves(e,o,a){for(var t=0;t<a.length;t++){var r=o+a[t];g_board[r]&eeColor&&GenerateMove(e,o,r)}}function GenerateStdMoves(e,o,a){for(var t=0;t<a.length;t++){for(var r=o+a[t];g_board[r]&colorEmpty;)GenerateMove(e,o,r),r+=a[t];g_board[r]&enColor&&GenerateMove(e,o,r)}}function MakeMove(e){var o=255&e,a=e>>8&255,t=16711680&e,r=g_board[o],s=15&r,g=a;if(g_captured=g_board[a],g_lastCastle=e&maskCastle|r&maskColor,t&moveflagCastleKing?(g_board[a-1]=g_board[a+1],g_board[a+1]=colorEmpty):t&moveflagCastleQueen?(g_board[a+1]=rook=g_board[a-2],g_board[a-2]=colorEmpty):t&moveflagPassing&&(g_captured=g_board[g=whiteTurn?a+16:a-16],g_board[g]=colorEmpty),undoStack.push(new cUndo),g_passing=0,15&g_captured?g_move50=0:(7&s)==piecePawn?(a==o+32&&(g_passing=o+16),a==o-32&&(g_passing=o-16),g_move50=0):g_move50++,t&moveflagPromotion){var n=-8&r;n|=t&moveflagPromoteKnight?pieceKnight:t&moveflagPromoteQueen?pieceQueen:t&moveflagPromoteBishop?pieceBishop:pieceRook,g_board[a]=n}else g_board[a]=g_board[o];g_board[o]=colorEmpty,g_castleRights&=boardCastle[o]&boardCastle[a],whiteTurn^=1,g_moveNumber++}function UnmakeMove(e){var o=255&e,a=e>>8&255,t=16711680&e,r=g_board[a],s=a,g=undoStack[undoStack.length-1];undoStack.pop(),g_passing=g.passing,g_castleRights=g.castle,g_move50=g.move50,g_lastCastle=g.lastCastle;var n=g.captured;t&moveflagCastleKing?(g_board[a+1]=g_board[a-1],g_board[a-1]=colorEmpty):t&moveflagCastleQueen&&(g_board[a-2]=g_board[a+1],g_board[a+1]=colorEmpty),t&moveflagPromotion?(r=-8&g_board[a]|piecePawn,g_board[o]=r):g_board[o]=g_board[a],t&moveflagPassing&&(s=whiteTurn?a-16:a+16,g_board[a]=colorEmpty),g_board[s]=n,whiteTurn^=1,g_moveNumber--}var bsIn=-1,bsFm="",bsPv="";function GetScore(e,o,a,t,r){for(var s=adjMobility,g=e.length,n=g,l=0,i="",c="";g--;){8191&++g_totalNodes||(g_stop=a>1&&(g_timeout&&Date.now()-g_startTime>g_timeout||g_nodeout&&g_totalNodes>g_nodeout));var m=e[g];MakeMove(m),g_depth=0,g_pv="";var v=GenerateAllMoves(whiteTurn),_=s-adjMobility;if(g_inCheck?(n--,_=-65535):g_move50>99?_=0:o<a&&(_=-GetScore(v,o+1,a,-r,-t)),UnmakeMove(m),g_stop)return-65535;if(t<_&&(t=_,c=(i=FormatMove(m))+" "+g_pv,l=g_depth+1,1==o)){g_scoreFm=_>61440?"mate "+(65535-_>>1):_<-61440?"mate "+(-65534-_>>1):"cp "+(_>>2),bsIn=g,bsFm=i,bsPv=c;var d=Date.now()-g_startTime,p=Math.floor(g_totalNodes/d*1e3);postMessage("info currmove "+bsFm+" currmovenumber "+g+" nodes "+g_totalNodes+" time "+d+" nps "+p+" depth "+g_depthout+" seldepth "+l+" score "+g_scoreFm+" pv "+bsPv)}if(t>=r)break}return n||(GenerateAllMoves(1^whiteTurn),t=g_inCheck?-65535+o:0),g_depth=l,g_pv=c,t}function Search(e,o,a){var t=GenerateAllMoves(whiteTurn);g_stop=!1,g_totalNodes=0,g_depthout=e||1,g_timeout=o,g_nodeout=a;do{bsIn=t.length-1;var r=GetScore(t,1,g_depthout,-65535,65535);if(t.push(t.splice(bsIn,1)),g_depth<g_depthout++||r<-61440||r>61440)break}while((!e||g_depthout<e)&&!g_stop);o=Date.now()-g_startTime;var s=Math.floor(g_totalNodes/o*1e3),g=bsPv.split(" "),n=g.length>1?" ponder "+g[1]:"";return postMessage("info nodes "+g_totalNodes+" time "+o+" nps "+s),postMessage("bestmove "+bsFm+n),!0}var cUndo=function(){this.captured=g_captured,this.passing=g_passing,this.castle=g_castleRights,this.move50=g_move50,this.lastCastle=g_lastCastle};function GetNumber(e,o,a){var t=o.exec(e);return t?0|t[1]:a}Initialize(),onmessage=function(e){/^(.*?)\n?$/.exec(e.data);var o=RegExp.$1;if("uci"==o)postMessage("id name Rapshort "+version),postMessage("id author Thibor Raven"),postMessage("uciok");else if("isready"==o)postMessage("readyok");else if(/^position (?:(startpos)|fen (.*?))\s*(?:moves\s*(.*))?$/.exec(o)){if(InitializeFromFen("startpos"==RegExp.$1?"":RegExp.$2),RegExp.$3)for(var a=RegExp.$3.split(" "),t=0;t<a.length;t++)MakeMove(GetMoveFromString(a[t]))}else if(/^go /.exec(o)){g_startTime=Date.now();var r=GetNumber(o,/movetime (\d+)/,0),s=GetNumber(o,/depth (\d+)/,0),g=GetNumber(o,/nodes (\d+)/,0);if(!r&&!s&&!g){var n=GetNumber(o,whiteTurn?/wtime (\d+)/:/btime (\d+)/,0),l=GetNumber(o,whiteTurn?/winc (\d+)/:/binc (\d+)/,0),i=GetNumber(o,/movestogo (\d+)/,32);r=Math.floor(n/i)+l-255}Search(s,r,g)}};