var version="18-02-01",piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,colorBlack=8,colorWhite=16,colorEmpty=32,moveflagPassing=2<<16,moveflagCastleKing=4<<16,moveflagCastleQueen=8<<16,moveflagPromotion=240<<16,moveflagPromoteQueen=16<<16,moveflagPromoteRook=32<<16,moveflagPromoteBishop=64<<16,moveflagPromoteKnight=8388608,maskCastle=moveflagCastleKing|moveflagCastleQueen,maskColor=colorBlack|colorWhite,g_baseEval=0,g_captured=0,g_castleRights=15,g_depth=0,g_passing=0,g_move50=0,g_moveNumber=0,g_pv="",g_totalNodes=0,g_startTime=0,g_inCheck=!1,g_depthout=0,g_timeout=0,g_nodeout=0,g_stop=!1,g_scoreFm="",g_lastCastle=0,undoStack=[],arrField=[],g_board=new Array(256),boardCheck=new Array(256),boardCastle=new Array(256),whiteTurn=1,usColor=0,enColor=0,eeColor=0,arrMaterial=[0,100,300,300,500,800,65535];function StrToSquare(e){return{a:0,b:1,c:2,d:3,e:4,f:5,g:6,h:7}[e.charAt(0)]+4|12-parseInt(e.charAt(1))<<4}function FormatSquare(e){return["a","b","c","d","e","f","g","h"][(15&e)-4]+(12-(e>>4))}function FormatMove(e){var o=FormatSquare(255&e)+FormatSquare(e>>8&255);return e&moveflagPromotion&&(o+=e&moveflagPromoteQueen?"q":e&moveflagPromoteRook?"r":e&moveflagPromoteBishop?"b":"n"),o}function GetMoveFromString(e){for(var o=GenerateAllMoves(whiteTurn),a=0;a<o.length;a++)if(FormatMove(o[a])==e)return o[a]}function Initialize(){arrField=[];for(var e=0;e<256;e++)boardCheck[e]=0,boardCastle[e]=15,g_board[e]=0;for(var o=0;o<8;o++)for(var a=0;a<8;a++)arrField.push(16*(o+4)+a+4);for(e=0;e<6;e++)boardCastle[[68,72,75,180,184,187][e]]=[7,3,11,13,12,14][e],boardCheck[[71,72,73,183,184,185][e]]=[colorBlack|moveflagCastleQueen,colorBlack|maskCastle,colorBlack|moveflagCastleKing,colorWhite|moveflagCastleQueen,colorWhite|maskCastle,colorWhite|moveflagCastleKing][e]}function InitializeFromFen(e){g_baseEval=0;for(var o=0;o<64;o++)g_board[arrField[o]]=colorEmpty;e||(e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");for(var a=e.split(" "),r=0,t=0,g=a[0],s=0;s<g.length;s++){var n=g.charAt(s);if("/"==n)r++,t=0;else if(n>="0"&&n<="9")for(var l=0;l<parseInt(n);l++)t++;else{var i=n.toLowerCase(),v=i!=n,_=v?colorWhite:colorBlack,c=16*(r+4)+t+4;switch(i){case"p":_|=piecePawn;break;case"b":_|=pieceBishop;break;case"n":_|=pieceKnight;break;case"r":_|=pieceRook;break;case"q":_|=pieceQueen;break;case"k":_|=pieceKing}g_board[c]=_;var m=arrMaterial[7&_];g_baseEval+=v?m:-m,t++}}whiteTurn="w"==a[1].charAt(0)|0,g_castleRights=0,-1!=a[2].indexOf("K")&&(g_castleRights|=1),-1!=a[2].indexOf("Q")&&(g_castleRights|=2),-1!=a[2].indexOf("k")&&(g_castleRights|=4),-1!=a[2].indexOf("q")&&(g_castleRights|=8),g_passing=0,-1==a[3].indexOf("-")&&(g_passing=StrToSquare(a[3])),g_move50=parseInt(a[4]),(g_moveNumber=parseInt(a[5]))&&g_moveNumber--,g_moveNumber*=2,whiteTurn||(g_moveNumber++,g_baseEval=-g_baseEval),undoStack=[]}function GenerateMove(e,o,a,r,t){r&&(e[e.length]=o|a<<8|t),((7&g_board[a])==pieceKing||(boardCheck[a]&g_lastCastle)==g_lastCastle&&g_lastCastle&maskCastle)&&(g_inCheck=!0)}function GenerateAllMoves(e){g_inCheck=!1,usColor=e?colorWhite:colorBlack,eeColor=(enColor=e?colorBlack:colorWhite)|colorEmpty;for(var o,a,r=[],t=0;t<64;t++){var g=arrField[t],s=g_board[g];if(s&usColor)switch(s&=7){case 1:g_board[o=g+(a=e?-16:16)]&colorEmpty&&(GeneratePwnMoves(r,g,o,!0),!g_board[g-a-a]&&g_board[o+a]&colorEmpty&&GeneratePwnMoves(r,g,o+a,!0)),g_board[o-1]&enColor?GeneratePwnMoves(r,g,o-1,!0):o-1==g_passing?GeneratePwnMoves(r,g,g_passing,!0,moveflagPassing):g_board[o-1]&colorEmpty&&GeneratePwnMoves(r,g,o-1,!1),g_board[o+1]&enColor?GeneratePwnMoves(r,g,o+1,!0):o+1==g_passing?GeneratePwnMoves(r,g,g_passing,!0,moveflagPassing):g_board[o+1]&colorEmpty&&GeneratePwnMoves(r,g,o+1,!1);break;case 2:GenerateShrMoves(r,g,[14,-14,18,-18,31,-31,33,-33]);break;case 3:GenerateStdMoves(r,g,[15,-15,17,-17]);break;case 4:GenerateStdMoves(r,g,[1,-1,16,-16]);break;case 5:GenerateStdMoves(r,g,[1,-1,15,-15,16,-16,17,-17]);break;case 6:GenerateShrMoves(r,g,[1,-1,15,-15,16,-16,17,-17]);var n=e?g_castleRights:g_castleRights>>2;1&n&&g_board[g+1]==colorEmpty&&g_board[g+2]==colorEmpty&&GenerateMove(r,g,g+2,!0,moveflagCastleKing),2&n&&g_board[g-1]==colorEmpty&&g_board[g-2]==colorEmpty&&g_board[g-3]==colorEmpty&&GenerateMove(r,g,g-2,!0,moveflagCastleQueen)}}return r}function GeneratePwnMoves(e,o,a,r,t){var g=a>>4;4!=g&&11!=g||!r?GenerateMove(e,o,a,r,t):(GenerateMove(e,o,a,r,moveflagPromoteQueen),GenerateMove(e,o,a,r,moveflagPromoteRook),GenerateMove(e,o,a,r,moveflagPromoteBishop),GenerateMove(e,o,a,r,moveflagPromoteKnight))}function GenerateShrMoves(e,o,a){for(var r=0;r<a.length;r++){var t=o+a[r];g_board[t]&eeColor&&GenerateMove(e,o,t,!0)}}function GenerateStdMoves(e,o,a){for(var r=0;r<a.length;r++){for(var t=o+a[r];g_board[t]&colorEmpty;)GenerateMove(e,o,t,!0),t+=a[r];g_board[t]&enColor&&GenerateMove(e,o,t,!0)}}function MakeMove(e){var o=255&e,a=e>>8&255,r=16711680&e,t=g_board[o],g=15&t,s=a;if(g_captured=g_board[a],g_lastCastle=e&maskCastle|t&maskColor,r&moveflagCastleKing?(g_board[a-1]=g_board[a+1],g_board[a+1]=colorEmpty):r&moveflagCastleQueen?(g_board[a+1]=rook=g_board[a-2],g_board[a-2]=colorEmpty):r&moveflagPassing&&(g_captured=g_board[s=whiteTurn?a+16:a-16],g_board[s]=colorEmpty),undoStack.push(new cUndo),g_passing=0,15&g_captured?(g_baseEval+=arrMaterial[7&g_captured],g_move50=0):(7&g)==piecePawn?(a==o+32&&(g_passing=o+16),a==o-32&&(g_passing=o-16),g_move50=0):g_move50++,r&moveflagPromotion){var n=-8&t;n|=r&moveflagPromoteKnight?pieceKnight:r&moveflagPromoteQueen?pieceQueen:r&moveflagPromoteBishop?pieceBishop:pieceRook,g_board[a]=n,g_baseEval-=arrMaterial[7&g],g_baseEval+=arrMaterial[7&n]}else g_board[a]=g_board[o];g_board[o]=colorEmpty,g_castleRights&=boardCastle[o]&boardCastle[a],g_baseEval=-g_baseEval,whiteTurn^=1,g_moveNumber++}function UnmakeMove(e){var o=255&e,a=e>>8&255,r=16711680&e,t=g_board[a],g=a,s=undoStack[undoStack.length-1];undoStack.pop(),g_passing=s.passing,g_castleRights=s.castle,g_move50=s.move50,g_baseEval=s.value,g_lastCastle=s.lastCastle;var n=s.captured;r&moveflagCastleKing?(g_board[a+1]=g_board[a-1],g_board[a-1]=colorEmpty):r&moveflagCastleQueen&&(g_board[a-2]=g_board[a+1],g_board[a+1]=colorEmpty),r&moveflagPromotion?(t=-8&g_board[a]|piecePawn,g_board[o]=t):g_board[o]=g_board[a],r&moveflagPassing&&(g=whiteTurn?a-16:a+16,g_board[a]=colorEmpty),g_board[g]=n,whiteTurn^=1,g_moveNumber--}var bsIn=-1,bsFm="",bsPv="";function GetScore(e,o,a,r,t,g){for(var s=e.length,n=s,l=n,i=0,v="",_="";n--;){8191&++g_totalNodes||(g_stop=r>1&&(g_timeout&&Date.now()-g_startTime>g_timeout||g_nodeout&&g_totalNodes>g_nodeout));var c=e[n],m=7&g_board[c>>8&255];MakeMove(c),g_depth=0,g_pv="";var d=-g_baseEval+s-o;if(g_move50>99)d=0;else if(a<r||m){var p=GenerateAllMoves(whiteTurn);g_inCheck?(l--,d=-65535):d=-GetScore(p,s,a+1,r,-g,-t)}if(UnmakeMove(c),g_stop)return-65535;if(t<d&&(t=d,_=(v=FormatMove(c))+" "+g_pv,i=g_depth+1,1==a)){g_scoreFm=d>61440?"mate "+(65535-d>>1):d<-61440?"mate "+(-65534-d>>1):"cp "+(d>>2),bsIn=n,bsFm=v,bsPv=_;var b=Date.now()-g_startTime,u=Math.floor(g_totalNodes/b*1e3);postMessage("info currmove "+bsFm+" currmovenumber "+n+" nodes "+g_totalNodes+" time "+b+" nps "+u+" depth "+g_depthout+" seldepth "+i+" score "+g_scoreFm+" pv "+bsPv)}if(t>=g)break}return l||(GenerateAllMoves(1^whiteTurn),t=g_inCheck?-65535+a:0),g_depth=i,g_pv=_,t}function Search(e,o,a){var r=GenerateAllMoves(whiteTurn),t=r.length,g=r.length-1;g_stop=!1,g_totalNodes=0,g_depthout=e||1,g_timeout=o,g_nodeout=a;do{bsIn=g;var s=GetScore(r,t,1,g_depthout,-65535,65535);if(bsIn!=g){var n=r[g];r[g]=r[bsIn],r[bsIn]=n}if(g_depth<g_depthout++||s<-61440||s>61440)break}while((!e||g_depthout<e)&&!g_stop&&g);o=Date.now()-g_startTime;var l=Math.floor(g_totalNodes/o*1e3),i=bsPv.split(" "),v=i.length>1?" ponder "+i[1]:"";return postMessage("info nodes "+g_totalNodes+" time "+o+" nps "+l),postMessage("bestmove "+bsFm+v),!0}var cUndo=function(){this.captured=g_captured,this.passing=g_passing,this.castle=g_castleRights,this.move50=g_move50,this.value=g_baseEval,this.lastCastle=g_lastCastle};function GetNumber(e,o,a){var r=o.exec(e);return r?0|r[1]:a}Initialize(),onmessage=function(e){/^(.*?)\n?$/.exec(e.data);var o=RegExp.$1;if("uci"==o)postMessage("id name Rapshort "+version),postMessage("id author Thibor Raven"),postMessage("uciok");else if("isready"==o)postMessage("readyok");else if(/^position (?:(startpos)|fen (.*?))\s*(?:moves\s*(.*))?$/.exec(o)){if(InitializeFromFen("startpos"==RegExp.$1?"":RegExp.$2),RegExp.$3)for(var a=RegExp.$3.split(" "),r=0;r<a.length;r++)MakeMove(GetMoveFromString(a[r]))}else if(/^go /.exec(o)){g_startTime=Date.now();var t=GetNumber(o,/movetime (\d+)/,0),g=GetNumber(o,/depth (\d+)/,0),s=GetNumber(o,/nodes (\d+)/,0);if(!t&&!g&&!s){var n=GetNumber(o,whiteTurn?/wtime (\d+)/:/btime (\d+)/,0),l=GetNumber(o,whiteTurn?/winc (\d+)/:/binc (\d+)/,0),i=GetNumber(o,/movestogo (\d+)/,32);t=Math.floor(n/i)+l-255}Search(g,t,s)}};